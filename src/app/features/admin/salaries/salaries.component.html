<div class="page">
  <div class="page-header">
    <div>
      <h3>üí∞ Salaries</h3>
      <p class="text-muted">Manage employee salary records</p>
    </div>
    <button (click)="showForm = !showForm" class="btn btn-primary">
      {{ showForm ? '‚úï Cancel' : '+ Add Salary' }}
    </button>
  </div>

  <div class="alert alert-success" *ngIf="successMsg">‚úÖ {{ successMsg }}</div>
  <div class="alert alert-danger"  *ngIf="errorMsg">‚ö†Ô∏è {{ errorMsg }}</div>

  <!-- Form -->
  <div class="form-card" *ngIf="showForm">
    <h6>Add Salary Record</h6>
    <form [formGroup]="form" (ngSubmit)="submit()">
      <div class="form-grid">
        <div class="form-group">
          <label>Employee <span class="required">*</span></label>
          <select formControlName="employeeId" class="form-select" [class.is-invalid]="f['employeeId'].invalid && f['employeeId'].touched">
            <option value="">-- Select Employee --</option>
            <option *ngFor="let e of employees" [value]="e.id">{{ e.name }}</option>
          </select>
          <div class="invalid-feedback" *ngIf="f['employeeId'].touched && f['employeeId'].invalid">Required.</div>
        </div>

        <div class="form-group">
          <label>Effective From <span class="required">*</span></label>
          <input formControlName="effectiveFrom" type="date" class="form-control"
            [class.is-invalid]="f['effectiveFrom'].invalid && f['effectiveFrom'].touched" />
          <div class="invalid-feedback" *ngIf="f['effectiveFrom'].touched && f['effectiveFrom'].invalid">Required.</div>
        </div>

        <div class="form-group">
          <label>Basic Salary (OMR) <span class="required">*</span></label>
          <input formControlName="basicSalary" type="number" min="0" class="form-control"
            [class.is-invalid]="f['basicSalary'].invalid && f['basicSalary'].touched"
            placeholder="0.000" />
          <div class="invalid-feedback" *ngIf="f['basicSalary'].touched && f['basicSalary'].invalid">Required, must be ‚â• 0.</div>
        </div>

        <div class="form-group">
          <label>Bonus (OMR)</label>
          <input formControlName="bonus" type="number" min="0" class="form-control" placeholder="0.000" />
        </div>

        <div class="form-group">
          <label>Deduction (OMR)</label>
          <input formControlName="deduction" type="number" min="0" class="form-control" placeholder="0.000" />
        </div>
      </div>

      <div class="form-actions">
        <button type="button" (click)="showForm=false" class="btn btn-outline-secondary">Cancel</button>
        <button type="submit" class="btn btn-primary" [disabled]="saving">
          <span *ngIf="saving" class="spinner-border spinner-border-sm me-1"></span>
          {{ saving ? 'Saving...' : 'Save Record' }}
        </button>
      </div>
    </form>
  </div>

  <!-- Filter -->
  <div class="filters">
    <div class="filter-group">
      <label>Filter by Employee</label>
      <select [(ngModel)]="filterEmpId" class="form-select">
        <option value="">All Employees</option>
        <option *ngFor="let e of employees" [value]="e.id">{{ e.name }}</option>
      </select>
    </div>
    <button (click)="filterEmpId=''" class="btn btn-outline-secondary mt-auto">Clear</button>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="loading-box"><div class="spinner-border text-primary"></div></div>

  <!-- Table -->
  <div class="table-card" *ngIf="!loading">
    <div class="table-info">Showing <strong>{{ filtered.length }}</strong> records</div>
    <div class="table-responsive">
      <table class="data-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Employee</th>
            <th>Basic (OMR)</th>
            <th>Bonus (OMR)</th>
            <th>Deduction (OMR)</th>
            <th>Net (OMR)</th>
            <th>Effective From</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let s of filtered; let i = index">
            <td class="text-muted">{{ i + 1 }}</td>
            <td class="fw-semibold">{{ s.employeeName }}</td>
            <td>{{ s.basicSalary | number:'1.3-3' }}</td>
            <td class="text-success">+{{ s.bonus | number:'1.3-3' }}</td>
            <td class="text-danger">-{{ s.deduction | number:'1.3-3' }}</td>
            <td class="net-salary">{{ totalNet(s) | number:'1.3-3' }}</td>
            <td>{{ s.effectiveFrom | date:'dd/MM/yyyy' }}</td>
            <td>
              <span class="badge-status" [class.active]="s.isCurrent" [class.inactive]="!s.isCurrent">
                {{ s.isCurrent ? 'Current' : 'Historical' }}
              </span>
            </td>
          </tr>
          <tr *ngIf="filtered.length === 0">
            <td colspan="8" class="empty-row">No salary records found.</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
